import { type SignedTransaction, SignedTransactionMeta } from '@algorandfoundation/algokit-transact'
import {
  addressArrayCodec,
  addressCodec,
  Address,
  ArrayCodec,
  bigIntCodec,
  booleanCodec,
  bytesArrayCodec,
  bytesCodec,
  MapCodec,
  ObjectModelCodec,
  numberCodec,
  stringCodec,
  type ObjectModelMetadata
} from '@algorandfoundation/algokit-common'

/** BlockEvalDelta represents a TEAL value delta (block/msgpack wire keys). */
export type BlockEvalDelta = {
  /** [at] delta action. */
  action: number
  /** [bs] bytes value. */
  bytes?: Uint8Array
  /** [ui] uint value. */
  uint?: bigint
}

export const BlockEvalDeltaMeta: ObjectModelMetadata<BlockEvalDelta> = {
  name: 'BlockEvalDelta',
  kind: 'object',
  fields: [
    { name: 'action', wireKey: 'at', optional: false, codec: numberCodec },
    { name: 'bytes', wireKey: 'bs', optional: true, codec: bytesCodec },
    { name: 'uint', wireKey: 'ui', optional: true, codec: bigIntCodec },
  ],
}

/**
 * State changes from application execution, including inner transactions and logs.
 */
export type BlockAppEvalDelta = {
  /** [gd] Global state delta for the application. */
  globalDelta?: Map<Uint8Array, BlockEvalDelta>
  /** [ld] Local state deltas keyed by address index. */
  localDeltas?: Map<number, Map<Uint8Array, BlockEvalDelta>>
  /** [itx] Inner transactions produced by this application execution. */
  innerTxns?: SignedTxnInBlock[]
  /** [sa] Shared accounts referenced by local deltas. */
  sharedAccounts?: string[]
  /** [lg] Application log outputs. */
  logs?: Uint8Array[]
}

export const BlockAppEvalDeltaMeta: ObjectModelMetadata<BlockAppEvalDelta> = {
  name: 'BlockAppEvalDelta',
  kind: 'object',
  fields: [
    {
      name: 'globalDelta',
      wireKey: 'gd',
      optional: true,
      codec: new MapCodec(bytesCodec, new ObjectModelCodec(BlockEvalDeltaMeta)),
    },
    {
      name: 'localDeltas',
      wireKey: 'ld',
      optional: true,
      codec: new MapCodec(numberCodec, new MapCodec(bytesCodec, new ObjectModelCodec(BlockEvalDeltaMeta))),
    },
    {
      name: 'innerTxns',
      wireKey: 'itx',
      optional: true,
      codec: new ArrayCodec(new ObjectModelCodec(() => SignedTxnInBlockMeta)),
    },
    {
      name: 'sharedAccounts',
      wireKey: 'sa',
      optional: true,
      codec: addressArrayCodec,
    },
    { name: 'logs', wireKey: 'lg', optional: true, codec: bytesArrayCodec },
  ],
}

/** Tracking metadata for a specific StateProofType. */
export type BlockStateProofTrackingData = {
  /** [v] Vector commitment root of state proof voters. */
  stateProofVotersCommitment?: Uint8Array
  /** [t] Online total weight during state proof round. */
  stateProofOnlineTotalWeight?: bigint
  /** [n] Next round for which state proofs are accepted. */
  stateProofNextRound?: bigint
}

export const BlockStateProofTrackingDataMeta: ObjectModelMetadata<BlockStateProofTrackingData> = {
  name: 'BlockStateProofTrackingData',
  kind: 'object',
  fields: [
    { name: 'stateProofVotersCommitment', wireKey: 'v', optional: true, codec: bytesCodec },
    { name: 'stateProofOnlineTotalWeight', wireKey: 't', optional: true, codec: bigIntCodec },
    { name: 'stateProofNextRound', wireKey: 'n', optional: true, codec: bigIntCodec },
  ],
}

export type ApplyData = {
  closingAmount?: bigint
  assetClosingAmount?: bigint
  senderRewards?: bigint
  receiverRewards?: bigint
  closeRewards?: bigint
  evalDelta?: BlockAppEvalDelta
  configAsset?: bigint
  applicationId?: bigint
}

export const ApplyDataMeta: ObjectModelMetadata<ApplyData> = {
  name: 'SignedTxnInBlock',
  kind: 'object',
  fields: [
    { name: 'closingAmount', wireKey: 'ca', optional: true, codec: bigIntCodec },
    { name: 'assetClosingAmount', wireKey: 'aca', optional: true, codec: bigIntCodec },
    { name: 'senderRewards', wireKey: 'rs', optional: true, codec: bigIntCodec },
    { name: 'receiverRewards', wireKey: 'rr', optional: true, codec: bigIntCodec },
    { name: 'closeRewards', wireKey: 'rc', optional: true, codec: bigIntCodec },
    { name: 'evalDelta', wireKey: 'dt', optional: true, codec: new ObjectModelCodec(BlockAppEvalDeltaMeta) },
    { name: 'configAsset', wireKey: 'caid', optional: true, codec: bigIntCodec },
    { name: 'applicationId', wireKey: 'apid', optional: true, codec: bigIntCodec },
  ],
}

/**
 * SignedTxnWithAD is a SignedTransaction with additional ApplyData.
 */
export type SignedTxnWithAD = {
  /** The signed transaction. */
  signedTxn: SignedTransaction
  /** Apply data containing transaction execution information. */
  applyData?: ApplyData
}

export const SignedTxnWithADMeta: ObjectModelMetadata<SignedTxnWithAD> = {
  name: 'SignedTxnWithAD',
  kind: 'object',
  fields: [
    {
      name: 'signedTxn',
      flattened: true,
      optional: false,
      codec: new ObjectModelCodec(SignedTransactionMeta),
    },
    {
      name: 'applyData',
      flattened: true,
      optional: true,
      codec: new ObjectModelCodec(ApplyDataMeta),
    },
  ],
}

/**
 * SignedTxnInBlock is a SignedTransaction with additional ApplyData and block-specific metadata.
 */
export type SignedTxnInBlock = {
  signedTxn: SignedTxnWithAD
  hasGenesisId?: boolean
  hasGenesisHash?: boolean
}

export const SignedTxnInBlockMeta: ObjectModelMetadata<SignedTxnInBlock> = {
  name: 'SignedTxnInBlock',
  kind: 'object',
  fields: [
    {
      name: 'signedTxn',
      flattened: true,
      optional: false,
      codec: new ObjectModelCodec(SignedTxnWithADMeta),
    },
    { name: 'hasGenesisId', wireKey: 'hgi', optional: true, codec: booleanCodec },
    { name: 'hasGenesisHash', wireKey: 'hgh', optional: true, codec: booleanCodec },
  ],
}

export type ParticipationUpdates = {
  /** [partupdrmv] Expired participation accounts. */
  expiredParticipationAccounts?: string[]
  /** [partupdabs] Absent participation accounts. */
  absentParticipationAccounts?: string[]
}

export const ParticipationUpdatesMeta: ObjectModelMetadata<ParticipationUpdates> = {
  name: 'ParticipationUpdates',
  kind: 'object',
  fields: [
    {
      name: 'expiredParticipationAccounts',
      wireKey: 'partupdrmv',
      optional: true,
      codec: addressArrayCodec,
    },
    {
      name: 'absentParticipationAccounts',
      wireKey: 'partupdabs',
      optional: true,
      codec: addressArrayCodec,
    },
  ],
}

export type BlockHeader = {
  /** [rnd] Round number. */
  round?: bigint
  /** [prev] Previous block hash. */
  previousBlockHash?: Uint8Array
  /** [prev512] Previous block hash using SHA-512. */
  previousBlockHash512?: Uint8Array
  /** [seed] Sortition seed. */
  seed?: Uint8Array
  /** [txn] Root of transaction merkle tree using SHA512_256. */
  transactionsRoot?: Uint8Array
  /** [txn256] Root of transaction vector commitment using SHA256. */
  transactionsRootSha256?: Uint8Array
  /** [txn512] Root of transaction vector commitment using SHA512. */
  transactionsRootSha512?: Uint8Array
  /** [ts] Block timestamp in seconds since epoch. */
  timestamp?: bigint
  /** [gen] Genesis ID. */
  genesisId?: string
  /** [gh] Genesis hash. */
  genesisHash?: Uint8Array
  /** [prp] Proposer address. */
  proposer?: Address
  /** [fc] Fees collected in this block. */
  feesCollected?: bigint
  /** [bi] Bonus incentive for block proposal. */
  bonus?: bigint
  /** [pp] Proposer payout. */
  proposerPayout?: bigint
  /** [fees] FeeSink address. */
  feeSink?: Address
  /** [rwd] RewardsPool address. */
  rewardsPool?: Address
  /** [earn] Rewards level. */
  rewardsLevel?: bigint
  /** [rate] Rewards rate. */
  rewardsRate?: bigint
  /** [frac] Rewards residue. */
  rewardsResidue?: bigint
  /** [rwcalr] Rewards recalculation round. */
  rewardsRecalculationRound?: bigint
  /** [proto] Current consensus protocol. */
  currentProtocol?: string
  /** [nextproto] Next proposed protocol. */
  nextProtocol?: string
  /** [nextyes] Next protocol approvals. */
  nextProtocolApprovals?: bigint
  /** [nextbefore] Next protocol vote deadline. */
  nextProtocolVoteBefore?: bigint
  /** [nextswitch] Next protocol switch round. */
  nextProtocolSwitchOn?: bigint
  /** [upgradeprop] Upgrade proposal. */
  upgradePropose?: string
  /** [upgradedelay] Upgrade delay in rounds. */
  upgradeDelay?: bigint
  /** [upgradeyes] Upgrade approval flag. */
  upgradeApprove?: boolean
  /** [tc] Transaction counter. */
  txnCounter?: bigint
  /** [spt] State proof tracking data keyed by state proof type. */
  stateProofTracking?: Map<number, BlockStateProofTrackingData>
  /** Represents participation account data that needs to be checked/acted on by the network */
  participationUpdates?: ParticipationUpdates
}

export const BlockHeaderMeta: ObjectModelMetadata<BlockHeader> = {
  name: 'BlockHeader',
  kind: 'object',
  fields: [
    { name: 'round', wireKey: 'rnd', optional: true, codec: bigIntCodec },
    { name: 'previousBlockHash', wireKey: 'prev', optional: true, codec: bytesCodec },
    { name: 'previousBlockHash512', wireKey: 'prev512', optional: true, codec: bytesCodec },
    { name: 'seed', wireKey: 'seed', optional: true, codec: bytesCodec },
    { name: 'transactionsRoot', wireKey: 'txn', optional: false, codec: bytesCodec },
    { name: 'transactionsRootSha256', wireKey: 'txn256', optional: true, codec: bytesCodec },
    { name: 'transactionsRootSha512', wireKey: 'txn512', optional: true, codec: bytesCodec },
    { name: 'timestamp', wireKey: 'ts', optional: true, codec: bigIntCodec },
    { name: 'genesisId', wireKey: 'gen', optional: true, codec: stringCodec },
    { name: 'genesisHash', wireKey: 'gh', optional: true, codec: bytesCodec },
    { name: 'proposer', wireKey: 'prp', optional: true, codec: addressCodec },
    { name: 'feesCollected', wireKey: 'fc', optional: true, codec: bigIntCodec },
    { name: 'bonus', wireKey: 'bi', optional: true, codec: bigIntCodec },
    { name: 'proposerPayout', wireKey: 'pp', optional: true, codec: bigIntCodec },
    { name: 'feeSink', wireKey: 'fees', optional: true, codec: addressCodec },
    { name: 'rewardsPool', wireKey: 'rwd', optional: true, codec: addressCodec },
    { name: 'rewardsLevel', wireKey: 'earn', optional: true, codec: bigIntCodec },
    { name: 'rewardsRate', wireKey: 'rate', optional: true, codec: bigIntCodec },
    { name: 'rewardsResidue', wireKey: 'frac', optional: true, codec: bigIntCodec },
    { name: 'rewardsRecalculationRound', wireKey: 'rwcalr', optional: true, codec: bigIntCodec },
    { name: 'currentProtocol', wireKey: 'proto', optional: true, codec: stringCodec },
    { name: 'nextProtocol', wireKey: 'nextproto', optional: true, codec: stringCodec },
    { name: 'nextProtocolApprovals', wireKey: 'nextyes', optional: true, codec: bigIntCodec },
    { name: 'nextProtocolVoteBefore', wireKey: 'nextbefore', optional: true, codec: bigIntCodec },
    { name: 'nextProtocolSwitchOn', wireKey: 'nextswitch', optional: true, codec: bigIntCodec },
    { name: 'upgradePropose', wireKey: 'upgradeprop', optional: true, codec: stringCodec },
    { name: 'upgradeDelay', wireKey: 'upgradedelay', optional: true, codec: bigIntCodec },
    { name: 'upgradeApprove', wireKey: 'upgradeyes', optional: true, codec: booleanCodec },
    { name: 'txnCounter', wireKey: 'tc', optional: true, codec: bigIntCodec },
    {
      name: 'stateProofTracking',
      wireKey: 'spt',
      optional: true,
      codec: new MapCodec(numberCodec, new ObjectModelCodec(BlockStateProofTrackingDataMeta)),
    },
    {
      name: 'participationUpdates',
      flattened: true,
      optional: true,
      codec: new ObjectModelCodec(ParticipationUpdatesMeta),
    },
  ],
}

/**
 * Block contains the BlockHeader and the list of transactions (Payset).
 */
export type Block = {
  /** The block information (Header) */
  header: BlockHeader

  /** [txns] Block transactions (Payset). */
  payset?: SignedTxnInBlock[]
}

export const BlockMeta: ObjectModelMetadata<Block> = {
  name: 'Block',
  kind: 'object',
  fields: [
    { name: 'header', flattened: true, optional: false, codec: new ObjectModelCodec(BlockHeaderMeta) },
    {
      name: 'payset',
      wireKey: 'txns',
      optional: true,
      codec: new ArrayCodec(new ObjectModelCodec(SignedTxnInBlockMeta)),
    },
  ],
}
