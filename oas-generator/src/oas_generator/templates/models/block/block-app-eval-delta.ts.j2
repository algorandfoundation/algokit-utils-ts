import type { ModelMetadata } from '../core/model-runtime';
import { getModelMeta } from '../core/model-runtime'
import { type BlockEvalDelta, BlockEvalDeltaMeta } from './block-eval-delta'
import { type SignedTxnInBlock } from './signed-txn-in-block'

/**
 * State changes from application execution, including inner transactions and logs.
 */
export type BlockAppEvalDelta = {
  /** [gd] Global state delta for the application. */
  globalDelta?: Map<Uint8Array, BlockEvalDelta>;
  /** [ld] Local state deltas keyed by address index. */
  localDeltas?: Map<number, Map<Uint8Array, BlockEvalDelta>>;
  /** [itx] Inner transactions produced by this application execution. */
  innerTxns?: SignedTxnInBlock[];
  /** [sa] Shared accounts referenced by local deltas. */
  sharedAccounts?: string[];
  /** [lg] Application log outputs. */
  logs?: Uint8Array[];
}

export const BlockAppEvalDeltaMeta: ModelMetadata = {
  name: 'BlockAppEvalDelta',
  kind: 'object',
  fields: [
    {
      name: 'globalDelta',
      wireKey: 'gd',
      optional: true,
      nullable: false,
      type: { kind: 'map', keyType: 'bytes', value: { kind: 'model', meta: BlockEvalDeltaMeta } },
    },
    {
      name: 'localDeltas',
      wireKey: 'ld',
      optional: true,
      nullable: false,
      type: {
        kind: 'map',
        keyType: 'number',
        value: { kind: 'map', keyType: 'bytes', value: { kind: 'model', meta: BlockEvalDeltaMeta } },
      },
    },
    { name: 'innerTxns', wireKey: 'itx', optional: true, nullable: false, type: { kind: 'array', item: { kind: 'model', meta: () => getModelMeta('SignedTxnInBlock') } } },
    { name: 'sharedAccounts', wireKey: 'sa', optional: true, nullable: false, type: { kind: 'array', item: { kind: 'scalar', isAddress: true } } },
    { name: 'logs', wireKey: 'lg', optional: true, nullable: false, type: { kind: 'array', item: { kind: 'scalar', isBytes: true } } },
  ],
};
